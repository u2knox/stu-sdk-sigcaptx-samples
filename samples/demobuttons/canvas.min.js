var canvas,ctx,formDiv,intf,isDown,lastPoint,m_btns,m_capability,m_encodingMode,m_imgData,m_inkThreshold,m_penData,m_usbDevices,modalBackground,protocol,tablet,BTN_TEXT_CANCEL="Закрыть",BTN_TEXT_CLEAR="Очистить",BTN_TEXT_OK="Отправить",MAXRETRIES=20,TIMEOUT_LONG=1e3,TIMEOUT_SHORT=500,m_clickBtn=-1,retry=0,documentUnid="",useType="";function checkForSigCaptX(){retry+=1,WacomGSS.STU.isServiceReady()?(retry=0,console.log("SigCaptX Web Service: ready")):(console.log("SigCaptX Web Service: not connected"),retry<MAXRETRIES?setTimeout(checkForSigCaptX,TIMEOUT_LONG):alert("Unable to establish connection to SigCaptX"))}function onDCAtimeout(){console.log("DCA disconnected"),setTimeout(close,0)}function Rectangle(t,e,n,i){this.x=t,this.y=e,this.width=n,this.height=i,this.Contains=function(t){return!!(t.x>=this.x)&&!!(t.x<=this.x+this.width)&&!!(t.y>=this.y)&&!!(t.y<=this.y+this.height)}}function Button(){this.Bounds,this.Text,this.Click}function Point(t,e){this.x=t,this.y=e}function createModalWindow(t,e){let n=document.getElementsByTagName("body")[0];(modalBackground=document.createElement("div")).id="modal-background",modalBackground.className="active",modalBackground.style.top=0,modalBackground.style.position="absolute",modalBackground.style.background="rgba(0, 0, 0, 0.6)",modalBackground.style.width="100%",modalBackground.style.height="100%",n.appendChild(modalBackground),(formDiv=document.createElement("div")).id="signatureWindow",formDiv.className="active",formDiv.style.top=window.innerHeight/2-e/2+"px",formDiv.style.left=window.innerWidth/2-t/2+"px",formDiv.style.width=t+"px",formDiv.style.height=e+"px",formDiv.style.position="absolute",formDiv.style.background="#fff",n.appendChild(formDiv),(canvas=document.createElement("canvas")).id="myCanvas",canvas.height=formDiv.offsetHeight,canvas.width=formDiv.offsetWidth,formDiv.appendChild(canvas),(ctx=canvas.getContext("2d")).fillStyle="white",ctx.fillRect(0,0,canvas.width,canvas.height),canvas.addEventListener?canvas.addEventListener("click",onCanvasClick,!1):canvas.attachEvent?canvas.attachEvent("onClick",onCanvasClick):canvas.onClick=onCanvasClick}function disconnect(){var t=Q.defer();if(null==tablet)t.resolve();else{var e=new WacomGSS.STU.Protocol;tablet.setInkingMode(e.InkingMode.InkingMode_Off).then(function(t){return console.log("received: "+JSON.stringify(t)),tablet.endCapture()}).then(function(t){return(console.log("received: "+JSON.stringify(t)),null!==m_imgData)?m_imgData.remove():t}).then(function(t){return console.log("received: "+JSON.stringify(t)),m_imgData=null,tablet.setClearScreen()}).then(function(t){return console.log("received: "+JSON.stringify(t)),tablet.disconnect()}).then(function(t){console.log("received: "+JSON.stringify(t)),tablet=null,clearCanvas(canvas,ctx)}).then(function(e){t.resolve()}).fail(function(e){console.log("disconnect error: "+e),t.resolve()})}return t.promise}function DCANotReady(){}function tabletDemo(t,e){useType=t,documentUnid=e,tabletDemoEx()}function tabletDemoEx(){var t,e,n,i=new WacomGSS.STU.Protocol;WacomGSS.STU.isDCAReady().then(function(t){if(!t)throw new DCANotReady;return WacomGSS.STU.onDCAtimeout=onDCAtimeout,WacomGSS.STU.getUsbDevices()}).then(function(t){if(null==t||0==t.length)throw Error("No STU devices found");return console.log("received: "+JSON.stringify(t)),m_usbDevices=t,WacomGSS.STU.isSupportedUsbDevice(m_usbDevices[0].idVendor,m_usbDevices[0].idProduct)}).then(function(e){return console.log("received: "+JSON.stringify(e)),(t=new WacomGSS.STU.UsbInterface).Constructor()}).then(function(e){return console.log("received: "+JSON.stringify(e)),t.connect(m_usbDevices[0],!0)}).then(function(i){return console.log("received: "+JSON.stringify(i)),(tablet=new WacomGSS.STU.Tablet).Constructor(t,e,n)}).then(function(e){return console.log("received: "+JSON.stringify(e)),t=null,tablet.getInkThreshold()}).then(function(t){return console.log("received: "+JSON.stringify(t)),m_inkThreshold=t,tablet.getCapability()}).then(function(t){return console.log("received: "+JSON.stringify(t)),createModalWindow((m_capability=t).screenWidth,m_capability.screenHeight),tablet.getInformation()}).then(function(t){return console.log("received: "+JSON.stringify(t)),tablet.getInkThreshold()}).then(function(t){return console.log("received: "+JSON.stringify(t)),tablet.getProductId()}).then(function(t){return console.log("received: "+JSON.stringify(t)),WacomGSS.STU.ProtocolHelper.simulateEncodingFlag(t,m_capability.encodingFlag)}).then(function(t){console.log("received: "+JSON.stringify(t));var e=t;return(e&i.EncodingFlag.EncodingFlag_24bit)!=0?tablet.supportsWrite().then(function(t){m_encodingMode=t?i.EncodingMode.EncodingMode_24bit_Bulk:i.EncodingMode.EncodingMode_24bit}):(e&i.EncodingFlag.EncodingFlag_16bit)!=0?tablet.supportsWrite().then(function(t){m_encodingMode=t?i.EncodingMode.EncodingMode_16bit_Bulk:i.EncodingMode.EncodingMode_16bit}):void(m_encodingMode=i.EncodingMode.EncodingMode_1bit)}).then(function(t){return tablet.setClearScreen()}).then(function(t){return console.log("received from setClearScreen: "+JSON.stringify(t)),t}).then(function(t){return console.log("received: "+JSON.stringify(t)),tablet.isSupported(i.ReportId.ReportId_PenDataOptionMode)}).then(function(t){return(console.log("received: "+JSON.stringify(t)),t)?tablet.getProductId().then(function(t){var e=i.PenDataOptionMode.PenDataOptionMode_None;switch(t){case WacomGSS.STU.ProductId.ProductId_520A:e=i.PenDataOptionMode.PenDataOptionMode_TimeCount;break;case WacomGSS.STU.ProductId.ProductId_430:case WacomGSS.STU.ProductId.ProductId_530:case WacomGSS.STU.ProductId.ProductId_540:e=i.PenDataOptionMode.PenDataOptionMode_TimeCountSequence;break;default:console.log("Unknown tablet supporting PenDataOptionMode, setting to None.")}return tablet.setPenDataOptionMode(e)}):m_encodingMode=i.EncodingMode.EncodingMode_1bit}).then(function(t){console.log("received: "+JSON.stringify(t)),addButtons();var e=canvas.toDataURL("image/jpeg");return WacomGSS.STU.ProtocolHelper.resizeAndFlatten(e,0,0,0,0,m_capability.screenWidth,m_capability.screenHeight,m_encodingMode,1,!1,0,!0)}).then(function(t){return m_imgData=t,console.log("received: "+JSON.stringify(t)),tablet.writeImage(m_encodingMode,t)}).then(function(t){return console.log("received: "+JSON.stringify(t)),tablet.setInkingMode(i.InkingMode.InkingMode_On)}).then(function(t){console.log("received: "+JSON.stringify(t));var e=new WacomGSS.STU.ProtocolHelper.ReportHandler;lastPoint={x:0,y:0},isDown=!1,ctx.lineWidth=1;var n=function(t){processButtons(t,canvas),processPoint(t,canvas,ctx),m_penData.push(t)},i=function(t){processButtons(t.penData[0],canvas),processPoint(t.penData[0],canvas,ctx),processButtons(t.penData[1],canvas),processPoint(t.penData[1],canvas,ctx),m_penData.push(t.penData[0],t.penData[1])},o=function(t){},a=function(t){};return m_penData=[],e.onReportPenData=n,e.onReportPenDataOption=n,e.onReportPenDataTimeCountSequence=n,e.onReportPenDataEncrypted=i,e.onReportPenDataEncryptedOption=i,e.onReportPenDataTimeCountSequenceEncrypted=n,e.onReportDevicePublicKey=o,e.onReportEncryptionStatus=o,e.decrypt=a,e.startReporting(tablet,!0)}).fail(function(t){console.log(t),t instanceof DCANotReady?(WacomGSS.STU.Reinitialize(),setTimeout(tabletDemoEx,TIMEOUT_LONG)):(alert("tabletDemoEx failed: "+t),setTimeout(close(),0))})}function addButtons(){if((m_btns=[,,,])[0]=new Button,m_btns[1]=new Button,m_btns[2]=new Button,m_usbDevices[0].idProduct!=WacomGSS.STU.ProductId.ProductId_300){var t=m_capability.screenWidth/3,e=m_capability.screenWidth/3,n=m_capability.screenWidth-t-e,i=6*m_capability.screenHeight/7,o=m_capability.screenHeight-i;m_btns[0].Bounds=new Rectangle(0,i,n,o),m_btns[1].Bounds=new Rectangle(n,i,t,o),m_btns[2].Bounds=new Rectangle(n+t,i,e,o)}else{var a=3*m_capability.screenWidth/4,c=m_capability.screenWidth-a,r=m_capability.screenHeight/3,s=m_capability.screenHeight/3,d=m_capability.screenHeight-r-s;m_btns[0].Bounds=new Rectangle(a,0,c,d),m_btns[1].Bounds=new Rectangle(a,d,c,r),m_btns[2].Bounds=new Rectangle(a,d+r,c,s)}m_btns[0].Text=BTN_TEXT_OK,m_btns[1].Text=BTN_TEXT_CLEAR,m_btns[2].Text=BTN_TEXT_CANCEL,m_btns[0].Click=btnOk_Click,m_btns[1].Click=btnClear_Click,m_btns[2].Click=btnCancel_Click,drawButtons()}function drawButtons(){ctx.save(),ctx.setTransform(1,0,0,1,0,0),ctx.beginPath(),ctx.lineWidth=1,ctx.strokeStyle="black",ctx.font="16px Arial";for(var t=0;t<m_btns.length;++t){ctx.fillStyle="lightgrey",ctx.fillRect(m_btns[t].Bounds.x,m_btns[t].Bounds.y,m_btns[t].Bounds.width,m_btns[t].Bounds.height),ctx.fillStyle="black",ctx.rect(m_btns[t].Bounds.x,m_btns[t].Bounds.y,m_btns[t].Bounds.width,m_btns[t].Bounds.height);var e,n=m_btns[t].Bounds.x+(m_btns[t].Bounds.width/2-ctx.measureText(m_btns[t].Text).width/2);e=m_usbDevices[0].idProduct==WacomGSS.STU.ProductId.ProductId_300?24:m_usbDevices[0].idProduct==WacomGSS.STU.ProductId.ProductId_430?22:36,ctx.fillText(m_btns[t].Text,n,m_btns[t].Bounds.y+e)}ctx.stroke(),ctx.closePath(),ctx.restore()}function clearScreen(){clearCanvas(canvas,ctx),drawButtons(),m_penData=[],tablet.writeImage(m_encodingMode,m_imgData)}function btnOk_Click(){saveImage(),setTimeout(close,0)}function btnCancel_Click(){setTimeout(close,0)}function btnClear_Click(){console.log("clear!"),clearScreen()}function distance(t,e){return Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)}function clearCanvas(t,e){e.save(),e.setTransform(1,0,0,1,0,0),e.fillStyle="white",e.fillRect(0,0,t.width,t.height),e.restore()}function processButtons(t,e){var n={};n.x=Math.round(e.width*t.x/m_capability.tabletMaxX),n.y=Math.round(e.height*t.y/m_capability.tabletMaxY);for(var i=isDown?!(t.pressure<=m_inkThreshold.offPressureMark):t.pressure>m_inkThreshold.onPressureMark,o=-1,a=0;a<m_btns.length;++a)if(m_btns[a].Bounds.Contains(n)){o=a;break}return isDown&&!i?(-1!=o&&m_clickBtn===o&&m_btns[o].Click(),m_clickBtn=-1):-1!=o&&!isDown&&i&&(m_clickBtn=o),-1==o}function processPoint(t,e,n){var i={};i.x=Math.round(e.width*t.x/m_capability.tabletMaxX),i.y=Math.round(e.height*t.y/m_capability.tabletMaxY);var o=isDown?!(t.pressure<=m_inkThreshold.offPressureMark):t.pressure>m_inkThreshold.onPressureMark;!isDown&&o&&(lastPoint=i),(o&&10<distance(lastPoint,i)||isDown&&!o)&&(n.beginPath(),n.moveTo(lastPoint.x,lastPoint.y),n.lineTo(i.x,i.y),n.stroke(),n.closePath(),lastPoint=i),isDown=o}async function saveImage(){var t=document.createElement("canvas");t.id="signatureCanvas",t.height=200,t.width=300;var e=t.getContext("2d");clearCanvas(t,e),e.lineWidth=1,e.strokeStyle="black",lastPoint={x:0,y:0},isDown=!1;for(var n=0;n<m_penData.length;n++)processPoint(m_penData[n],t,e);await fetch(`http://10.40.240.118/?.handler=Rest&f=test_123&type=${useType}&unid=${documentUnid}`,{body:JSON.stringify({file:t.toDataURL().split(";base64,")[1]}),method:"POST",headers:{"Content-Type":"application/json"},mode:"cors"})}function generateImage(){signatureImage=new Image(300,200);var t=document.createElement("canvas");t.id="signatureCanvas",t.height=signatureImage.height,t.width=signatureImage.width;var e=t.getContext("2d");clearCanvas(t,e),e.lineWidth=1,e.strokeStyle="black",lastPoint={x:0,y:0},isDown=!1;for(var n=0;n<m_penData.length;n++)processPoint(m_penData[n],t,e);signatureImage.src=t.toDataURL("image/jpeg")}function close(){WacomGSS.STU.onDCAtimeout=null,disconnect(),document.getElementsByTagName("body")[0].removeChild(modalBackground),document.getElementsByTagName("body")[0].removeChild(formDiv)}function onCanvasClick(t){for(var e=t.pageX-formDiv.offsetLeft,n=t.pageY-formDiv.offsetTop,i=0;i<m_btns.length;i++)if(m_btns[i].Bounds.Contains(new Point(e,n))){m_btns[i].Click();break}}setTimeout(checkForSigCaptX,TIMEOUT_SHORT),window.addEventListener("beforeunload",function(t){return WacomGSS.STU.close(),(t||window.event).returnValue="",""}),DCANotReady.prototype=Error();